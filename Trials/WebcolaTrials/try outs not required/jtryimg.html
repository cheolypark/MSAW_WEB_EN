<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Incremental exploration of a large graph</title>
<style>
@import url(../../style.css);

.background {
    stroke: gray;
    stroke-width: 1px;
    fill: white;
}
.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .8;
}

</style>
</head>
<body>
<script src="../../extern/d3v4.js"></script>
<script src="../../extern/d3.v3.js"></script>
<script src="../../extern/fullscreen.js"></script>
<script src="../../cola.min.js"></script>
<script>
    var width = 960,
        height = 500,
        imageScale = 0.25;

   // var color = d3.scaleOrdinal(d3.schemeCategory20);

    var cola = cola.d3adaptor(d3)
        .linkDistance(60)
        .size([width, height]);

    var outer = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("pointer-events", "all");

    outer.append('rect')
        .attr('class', 'background')
        .attr('width', "100%")
        .attr('height', "100%")
        .call(d3.behavior.zoom().on("zoom", redraw));

    var vis = outer
        .append('g');

    var nodeMouseDown = false;

    function redraw() {
        if (nodeMouseDown) return;
        vis.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")");
    }

    var edgesLayer = vis.append("g");
    var nodesLayer = vis.append("g");

    var modelgraph, viewgraph = { groups: [], links: [] };
    var conData=[
    {"type":"alignment",
     "axis":"y",
     "offsets":[
       {"node":"0", "offset":"0"},
       {"node":"1", "offset":"0"},
       {"node":"2", "offset":"0"},
       {"node":"3", "offset":"0"},
       {"node":"5", "offset":"100"},
       {"node":"4", "offset":"100"},
       {"node":"6", "offset":"-100"}
     ]},
    {"type":"alignment",
     "axis":"x",
     "offsets":[
       {"node":"0", "offset":"120"},
       {"node":"1", "offset":"250"},
       {"node":"2", "offset":"450"},
       {"node":"3", "offset":"650"},
       {"node":"4", "offset":"250"},
       {"node":"5", "offset":"450"},
       {"node":"6", "offset":"350"}
     ]}
  ];
    d3.json("graphdata/msawData.json", function (error, g) {
        modelgraph = g;
        var startNode = getNode("Process 1");
        addViewNode(startNode);
        refocus(startNode);
        update();
    });

    function refocus(focus) {
        modelgraph.links.forEach(function (l) {
            var u = modelgraph.groups[l.source], v = modelgraph.groups[l.target];
            if (u === focus && !inView(v)) addViewNode(v, focus);
            if (v === focus && !inView(u)) addViewNode(u, focus);
        });
        viewgraph.links = [];
        
        viewgraph.groups.forEach(function (v) {v.colour = "blue"});
        modelgraph.links.forEach(function (l) {
            var u = modelgraph.groups[l.source], v = modelgraph.groups[l.target];
            if (inView(u) && inView(v)) viewgraph.links.push({ source: u, target: v });
            
        });
    }

    function inView(v) { return typeof v.viewgraphid !== 'undefined'; }

    function addViewNode(v, startpos) {
        v.viewgraphid = viewgraph.groups.length;
        if (typeof startpos !== 'undefined') {
            v.x = startpos.x;
            v.y = startpos.y;
        }
        viewgraph.groups.push(v);
    }

    function getNode(name) {
        var v, i = modelgraph.groups.length;
        while (i--) if ((v = modelgraph.groups[i]).gname == name) return v;
        return null;
    }

    function click(node) {
        if (node.colour == "blue") return;
        var focus = getNode(node.gname);
        refocus(focus);
        update();
    }

    function toggleImageZoom(img) {
        var scale = 1;
        d3.select(img).each(function (d) {
            if (Math.abs(img.width.baseVal.value - d.width) < 1) scale /= imageScale;
        });
        imageZoom(img, scale);
    }

    function imageZoom(img, scale) {
        d3.select(img)
            .transition()
            .attr("width", function (d) {
                return scale * d.width;
            })
            .attr("height", function (d) { return scale * d.height; });
    }

    function update() {
        cola.nodes(viewgraph.groups)
            .links(viewgraph.links)
            //.constraints(conData)
            .start(10,10,10);

        var link = edgesLayer.selectAll(".link")
            .data(viewgraph.links);

        link.enter().append("line")
            .attr("class", "link")
            .style("stroke-width", 2);

        link.exit().remove();

        var node = nodesLayer.selectAll(".node")
            .data(viewgraph.groups, function (d) { return d.viewgraphid; });

        var enter = node.enter().append("g")
            .attr("class", function (d) { return "node" + ('image' in d ? ' imagenode' : '') })
            .on("mousedown", function () { nodeMouseDown = true; })
            .on("mouseup", function () { nodeMouseDown = false; })
            .on("touchmove", function () {
                d3.event.preventDefault()
            })
            .call(cola.drag);

       

enter.append("rect")
        .attr("width", function (d) { return d.width - 2 * 1; })
        .attr("height", function (d) { return d.height - 2 * 1; })
        .attr("rx", 5).attr("ry", 5);

        // enter.append("circle")
        //     .attr("r", 7)
        //     .on("click", function (d) { click(d) })
        //     .on("touchend", function (d) { click(d) });
 nodesLayer.selectAll(".imagenode")
            .attr("class", "node")
            .append("image")
            .attr("xlink:href", function (d) {
                var url = "graphdata/o.png";
                var simg = this;
                var img = new Image();
                img.onload = function () {
                    d.width = this.width * imageScale;
                    d.height = this.height * imageScale;
                    simg.setAttribute("width", d.width);
                    simg.setAttribute("height", d.height);
                }
                return img.src = url;
            })
//            .on("mouseover", function () { imageZoom(this, 1/imageScale) })
            .on("touchend", function () { toggleImageZoom(this) })
            .on("mouseout", function () { imageZoom(this, 1) });
        node.style("fill", function (d) { return d.colour; })
            .append("title")
            .text(function (d) { return d.gname; });

        cola.on("tick", function () {
            link.attr("x1", function (d) { return d.source.x; })
                .attr("y1", function (d) { return d.source.y; })
                .attr("x2", function (d) { return d.target.x; })
                .attr("y2", function (d) { return d.target.y; });

            node.attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });
        });
    }
</script>

</body>
</html>
